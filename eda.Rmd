Bryan Flores
ADS-503
Final Project: Exploratory Analysis

```{r}
setwd("C:/Users/Rudy/OneDrive/MADS/503_Applied Predictive Modeling/finalproject/data/")
# CSV Upload
met_21_22 = read.csv("met_21_22_9755371.csv", header=TRUE, stringsAsFactors=FALSE)
met_22_23 = read.csv('met_22_23_9755371.csv', header=TRUE, stringsAsFactors = FALSE)
wl_21_23 = read.csv('wl_21_23_9755371.csv', header=TRUE, stringsAsFactors = FALSE)
pacIOOS_21_22 = read.csv('dhw_5km_6a81_de46_d4a4.csv', header=TRUE, stringsAsFactors = FALSE)
pacIOOS_22_23 = read.csv('dhw_5km_db8d_5daf_80ed.csv', header=TRUE, stringsAsFactors = FALSE)
```
```{r}
# Examine the input table structures
str(met_21_22)
str(met_22_23)
str(wl_21_23)
str(pacIOOS_21_22)
str(pacIOOS_22_23)
```

```{r}
# Combine years for meteorological & coral tables
library('dplyr')
met21_23 = bind_rows(met_21_22, met_22_23)
coral21_23 = bind_rows(pacIOOS_21_22, pacIOOS_22_23)
```
```{r}
# Examine the meteorological tables
dim(met21_23)
colnames(met21_23)
str(met21_23)
```
```{r}
# Examine the water level table
dim(wl_21_23)
colnames(wl_21_23)
str(wl_21_23)
```
```{r}
# Examine the coral data
dim(coral21_23)
colnames(coral21_23)
str(coral21_23)
```
```{r}
# Convert coral table column names to lowercase
names(coral21_23) = tolower(names(coral21_23))
coral21_23
```
```{r}
# Convert coral datetime column to a standard date format. YYYY-MM-DD
## The coral timestamp field marks 6 data points at the beginning of each day.
### Extracting date from timestamp column
coral21_23$date = format(as.POSIXct(coral21_23$time), format="%Y-%m-%d")
```

There are now 3 tables each span 2021 through 2023 with a standard date format.

```{r}
# Count total missing values in each column of data frame
## Coral
sapply(coral21_23, function(x) sum(is.na(x)))
## Meteorological
sapply(met21_23, function(x) sum(is.na(x)))
## Water Level
sapply(wl_21_23, function(x) sum(is.na(x)))
```

There are no missing values in any of the tables. 
---
All Coral _mask suffix columns contain only zeros and will be dropped from the data frame since we cannot confirm whether this an accurate or a missed reading based on the information provided from its source. The date column was created by removing the timestamp from the time column.

Coral columns to be dropped: time, crw_baa_mask, crw_dhw_mask, crw_hotspot_mask, and crw_sst_anomaly_mask
---
The meteorological data contains 5 columns with not null empty values and shall be dropped. Time will also be dropped due to an inaccuracy in the mapping with the coral table.

Meteorological columns to be dropped: time, wind_speed, wind_direction, wind_gust, humidity, and visibility
---
The Water Level (WL) inf column contains no information and shall be dropped.

```{r}
# Dropping empty columns from each table
coral21_23_sub = subset(coral21_23, select = -c(crw_baa_mask, crw_dhw_mask, crw_hotspot_mask,
                                                crw_sstanomaly_mask, time))
met21_23_sub = subset(met21_23, select = -c(wind_speed, wind_direction, wind_gust, humidity,
                                            visibility, time))
wl_21_23_sub = subset(wl_21_23, select = -c(inf, time))
```

The coral table has 6 measurements per day with a timestamp of 00:00, which is why it was removed. The meteorological table has 1 measurement per hour per day. Lastly, the water level table has 1 measurement per month. 

Coral: This is the central table the meteorological and water level tables will be manipulated for.

Meteor.: The ideal mapping would be to break up the hourly measurements into 6 4-measurement groups. The caveat to this approach in our case is that there is no way to be which order the coral measurements were taken -- simultaneously or sequentially. Therefore, we will use the daily average of air temperature and barometric metric pressure and apply a one-to-many mapping with the coral measurements. Air temperature and barometric pressure will be represented 6 times per day.

Water Level: Apply a one-to-many mapping with the coral table. Each monthly water level measurement will be represented 6 times per day per month. Water level measurements were only taken on the first of every month. Therefore, we will have to join on the yyyy-mm of the date column. For simplicity, I will create a new year-month column in each dataframe, then drop it once the merge is complete.

```{r}
# Convert air temp & baro columns to numeric
met21_23_sub = transform(met21_23_sub, air_temp = as.numeric(air_temp), baro = as.numeric(baro))
```
```{r}
# Find daily averages: air temperature & barometric pressure
met21_23_sub_avg = aggregate(met21_23_sub[, 2:3], list(met21_23_sub$date), mean)
met21_23_sub_avg
```
```{r}
# Change new subset column name
colnames(met21_23_sub_avg) = c('date', 'air_temp', 'baro')
# Convert air temperature to celcius from fahrenheit
library(weathermetrics)
met21_23_sub_avg$air_temp = fahrenheit.to.celsius(met21_23_sub_avg$air_temp, round = 2)
```

```{r}
# Map Meteorological to Coral
coral_met = merge(x = coral21_23_sub, y = met21_23_sub_avg, by="date", all.x=TRUE)
```
```{r}
# Map Water Level to Coral/Met Table
## Add year-month columns for merging
coral_met$ym = format(as.Date(coral_met$date), "%Y-%m")
wl_21_23_sub$ym = format(as.Date(wl_21_23_sub$date), "%Y-%m")

cmw_merged = merge(x = coral_met, y = wl_21_23_sub, by="ym", all.x=TRUE)
## Dropping year-month column
cmw_merged = subset(select(cmw_merged, -c(ym, latitude, longitude, date.y)))
## Rename date column
colnames(cmw_merged)[1] = "date"
```

The final set before exploratory analysis and feature selection is cmw_merged. The year-month column, ym, has been removed along with latitude and longitude. Latitude and longitude were necessary in obtaining the data, however, the area of the measurements taken will remain constant over the period of our data set. 

Our final set contains 4386 rows and 19 columns -- 6 measurements per day per month from 5/27/2021 through 5/27/2023. CRW_BAA is the predictor column is the bleaching alert area containing 5 classes: 0 for no stress, 1 for bleaching watch, 2 for bleaching warning, 3 for bleaching alert level 1, and 4 for bleaching alert level 2. 

--- 
EXPLORATORY ANALYSIS

```{r}
# library(tidyverse)
library(ggplot2)
# Distribution of the bleaching hotspot
hist(cmw_merged$crw_hotspot, xlab="Hotspot (Celsius)", main = "Frequency Histogram of Bleaching Hotspot", col = "seagreen3")
```
```{r}
# Distribution of bleaching alert area
hist(cmw_merged$crw_baa, xlab="Alert Area", main = "Frequency Histogram of Bleaching Alert Area", col = "seagreen3")
```

```{r}
# Difference in hotspot temperatures between bleaching alert area classes
boxplot(crw_hotspot ~ crw_baa, data=cmw_merged, col="salmon", 
        xlab = "Alert Area", ylab = "Hotspot", main = "Coral Bleaching Hotspot & Alert Area")
```


































